#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script de Debug para Gr√°ficos - Verifica n√∫meros incorretos
"""

import sys
import os

# Adicionar o diret√≥rio backend ao path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'backend'))

from flask import Flask
from app import create_app
from app.services.dashboard.ocorrencia_dashboard import get_ocorrencia_dashboard_data


def debug_grafico_ocorrencias_por_tipo():
    """Debug espec√≠fico para o gr√°fico de ocorr√™ncias por tipo"""
    print("üîç DEBUG: Gr√°fico Ocorr√™ncias por Tipo")
    print("=" * 60)
    
    # Teste 1: Sem filtros
    print("\n1Ô∏è‚É£ TESTE SEM FILTROS:")
    filters_sem = {
        "data_inicio_str": "2024-01-01",
        "data_fim_str": "2024-01-31",
        "supervisor_id": None,
        "condominio_id": None,
        "turno": None,
        "status": None
    }
    
    try:
        result_sem = get_ocorrencia_dashboard_data(filters_sem)
        print(f"   Total de ocorr√™ncias: {result_sem.get('total_ocorrencias', 'N/A')}")
        print(f"   Tipos encontrados: {len(result_sem.get('tipo_labels', []))}")
        
        print("   üìä Dados do gr√°fico:")
        tipo_labels = result_sem.get('tipo_labels', [])
        tipo_data = result_sem.get('ocorrencias_por_tipo_data', [])
        for i, (label, data) in enumerate(zip(tipo_labels, tipo_data)):
            print(f"      {i+1}. {label}: {data}")
            
    except Exception as e:
        print(f"   ‚ùå ERRO: {e}")
    
    # Teste 2: Com supervisor espec√≠fico
    print("\n2Ô∏è‚É£ TESTE COM SUPERVISOR ESPEC√çFICO:")
    filters_com = {
        "data_inicio_str": "2024-01-01",
        "data_fim_str": "2024-01-31",
        "supervisor_id": 1,  # Testar com supervisor ID 1
        "condominio_id": None,
        "turno": None,
        "status": None
    }
    
    try:
        result_com = get_ocorrencia_dashboard_data(filters_com)
        print(f"   Total de ocorr√™ncias: {result_com.get('total_ocorrencias', 'N/A')}")
        print(f"   Tipos encontrados: {len(result_com.get('tipo_labels', []))}")
        
        print("   üìä Dados do gr√°fico (filtrado por supervisor):")
        tipo_labels = result_com.get('tipo_labels', [])
        tipo_data = result_com.get('ocorrencias_por_tipo_data', [])
        for i, (label, data) in enumerate(zip(tipo_labels, tipo_data)):
            print(f"      {i+1}. {label}: {data}")
            
        # Verificar se h√° n√∫meros suspeitos
        for label, data in zip(tipo_labels, tipo_data):
            if data > 1000:  # N√∫meros suspeitamente altos
                print(f"      ‚ö†Ô∏è  ATEN√á√ÉO: {label} tem {data} ocorr√™ncias (n√∫mero suspeito!)")
                
    except Exception as e:
        print(f"   ‚ùå ERRO: {e}")
    
    # Teste 3: Comparar totais
    print("\n3Ô∏è‚É£ COMPARA√á√ÉO:")
    try:
        if 'result_sem' in locals() and 'result_com' in locals():
            total_sem = result_sem.get('total_ocorrencias', 0)
            total_com = result_com.get('total_ocorrencias', 0)
            
            print(f"   Total sem filtro: {total_sem}")
            print(f"   Total com supervisor: {total_com}")
            
            if total_com > total_sem:
                print(f"   ‚ùå PROBLEMA: Total com supervisor ({total_com}) √© MAIOR que sem filtro ({total_sem})")
                print(f"      Isso indica um problema na l√≥gica de filtros!")
            elif total_com == total_sem:
                print(f"   ‚ö†Ô∏è  ATEN√á√ÉO: Total com supervisor ({total_com}) √© IGUAL ao sem filtro ({total_sem})")
                print(f"      O filtro pode n√£o estar funcionando!")
            else:
                print(f"   ‚úÖ OK: Total com supervisor ({total_com}) √© menor que sem filtro ({total_sem})")
                
    except Exception as e:
        print(f"   ‚ùå ERRO na compara√ß√£o: {e}")


def debug_grafico_ocorrencias_por_condominio():
    """Debug espec√≠fico para o gr√°fico de ocorr√™ncias por condom√≠nio"""
    print("\nüîç DEBUG: Gr√°fico Ocorr√™ncias por Condom√≠nio")
    print("=" * 60)
    
    # Teste 1: Sem filtros
    print("\n1Ô∏è‚É£ TESTE SEM FILTROS:")
    filters_sem = {
        "data_inicio_str": "2024-01-01",
        "data_fim_str": "2024-01-31",
        "supervisor_id": None,
        "condominio_id": None,
        "turno": None,
        "status": None
    }
    
    try:
        result_sem = get_ocorrencia_dashboard_data(filters_sem)
        print(f"   Total de ocorr√™ncias: {result_sem.get('total_ocorrencias', 'N/A')}")
        print(f"   Condom√≠nios encontrados: {len(result_sem.get('condominio_labels', []))}")
        
        print("   üè¢ Dados do gr√°fico:")
        cond_labels = result_sem.get('condominio_labels', [])
        cond_data = result_sem.get('ocorrencias_por_condominio_data', [])
        for i, (label, data) in enumerate(zip(cond_labels, cond_data)):
            print(f"      {i+1}. {label}: {data}")
            
    except Exception as e:
        print(f"   ‚ùå ERRO: {e}")
    
    # Teste 2: Com supervisor espec√≠fico
    print("\n2Ô∏è‚É£ TESTE COM SUPERVISOR ESPEC√çFICO:")
    filters_com = {
        "data_inicio_str": "2024-01-01",
        "data_fim_str": "2024-01-31",
        "supervisor_id": 1,  # Testar com supervisor ID 1
        "condominio_id": None,
        "turno": None,
        "status": None
    }
    
    try:
        result_com = get_ocorrencia_dashboard_data(filters_com)
        print(f"   Total de ocorr√™ncias: {result_com.get('total_ocorrencias', 'N/A')}")
        print(f"   Condom√≠nios encontrados: {len(result_com.get('condominio_labels', []))}")
        
        print("   üè¢ Dados do gr√°fico (filtrado por supervisor):")
        cond_labels = result_com.get('condominio_labels', [])
        cond_data = result_com.get('ocorrencias_por_condominio_data', [])
        for i, (label, data) in enumerate(zip(cond_labels, cond_data)):
            print(f"      {i+1}. {label}: {data}")
            
        # Verificar se h√° n√∫meros suspeitos
        for label, data in zip(cond_labels, cond_data):
            if data > 1000:  # N√∫meros suspeitamente altos
                print(f"      ‚ö†Ô∏è  ATEN√á√ÉO: {label} tem {data} ocorr√™ncias (n√∫mero suspeito!)")
                
    except Exception as e:
        print(f"   ‚ùå ERRO: {e}")


def main():
    """Fun√ß√£o principal"""
    print("üöÄ DEBUG DOS GR√ÅFICOS - Verificando n√∫meros incorretos")
    print("=" * 80)
    
    # Criar app Flask para contexto
    app = create_app()
    
    with app.app_context():
        # Debug do gr√°fico de tipos
        debug_grafico_ocorrencias_por_tipo()
        
        # Debug do gr√°fico de condom√≠nios
        debug_grafico_ocorrencias_por_condominio()
        
        print("\n" + "=" * 80)
        print("üí° AN√ÅLISE:")
        print("   - Se os n√∫meros com supervisor s√£o maiores que sem filtro, h√° problema na l√≥gica")
        print("   - Se os n√∫meros s√£o iguais, o filtro n√£o est√° funcionando")
        print("   - Se h√° n√∫meros muito altos (ex: 50 mil), pode haver problema na view ou joins")
        print("   - Verifique se a view VWOcorrenciasDetalhadas est√° correta")


if __name__ == "__main__":
    main()
