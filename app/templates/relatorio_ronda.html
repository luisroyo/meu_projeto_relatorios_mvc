{% extends "base.html" %}
{% block title %}{{ title }} - Assistente de Relatórios IA{% endblock %}

{% block content %}
<div class="container-fluid mt-lg-3">
    <div class="page-header text-center">
        <h1>{{ title }}</h1>
        <p class="lead">Insira os dados do plantão e o log bruto das rondas para gerar o relatório formatado.</p>
    </div>

    <div class="row">
        <!-- Formulário -->
        <div class="col-12 col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <h5 class="mb-0">Dados do Plantão e Log de Rondas</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('ronda.registrar_ronda') }}" novalidate>
                        {{ form.hidden_tag() }}
                        
                        {{ form.nome_condominio.label(class="form-label") }}
                        {{ form.nome_condominio(class="form-select", id="nome_condominio_select") }}

                        <div id="outro_condominio_div" {% if form.nome_condominio.data != 'Outro' %}style="display: none;"{% endif %}>
                            {{ form.nome_condominio_outro.label(class="form-label") }}
                            {{ form.nome_condominio_outro(class="form-control") }}
                        </div>

                        {{ form.data_plantao.label(class="form-label") }}
                        {{ form.data_plantao(class="form-control") }}

                        {{ form.escala_plantao.label(class="form-label") }}
                        {{ form.escala_plantao(class="form-select") }}

                        {{ form.log_bruto_rondas.label(class="form-label") }}
                        {{ form.log_bruto_rondas(class="form-control", rows="10") }}

                        <div class="mt-3">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Resultado -->
        <div class="col-12 col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <h5 class="mb-0">Relatório Gerado</h5>
                </div>
                <div class="card-body p-4">
                    <div class="report-output-container">
                        {% if relatorio_processado %}
                            {% if relatorio_processado is string and relatorio_processado.startswith("Erro:") %}
                                <pre class="alert alert-danger">{{ relatorio_processado }}</pre>
                            {% elif "Nenhum evento de ronda válido" in relatorio_processado %}
                                <div class="alert alert-warning">{{ relatorio_processado }}</div>
                            {% elif relatorio_processado is string %}
                                <pre>{{ relatorio_processado }}</pre>
                            {% else %}
                                <p class="alert alert-warning">Formato não reconhecido</p>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-secondary">O relatório processado aparecerá aqui.</div>
                        {% endif %}
                    </div>

                    <button type="button" class="btn btn-info mt-3" id="copiarRelatorioRonda" style="display: none;">Copiar Relatório</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const select = document.getElementById('nome_condominio_select');
        const outroDiv = document.getElementById('outro_condominio_div');

        if (select && outroDiv) {
            select.addEventListener('change', function () {
                outroDiv.style.display = select.value === 'Outro' ? 'block' : 'none';
            });
        }

        const resultadoTextoEl = document.querySelector('.report-output-container pre, .report-output-container div.alert');
        const btnCopiar = document.getElementById('copiarRelatorioRonda');

        function atualizarBotao() {
            if (!resultadoTextoEl || !btnCopiar) return;
            const texto = resultadoTextoEl.innerText.trim();
            const isPlaceholder = texto.includes("aparecerá aqui");
            const isError = resultadoTextoEl.classList.contains('alert-danger');
            btnCopiar.style.display = texto && !isPlaceholder && !isError ? 'inline-block' : 'none';
        }

        atualizarBotao();

        // Copiar relatório
        btnCopiar.addEventListener('click', function () {
            navigator.clipboard.writeText(resultadoTextoEl.innerText).then(() => {
                btnCopiar.textContent = 'Copiado!';
                setTimeout(() => btnCopiar.textContent = 'Copiar Relatório', 2000);
            }).catch(() => alert('Falha ao copiar.'));
        });
    });
</script>

{% endblock %}