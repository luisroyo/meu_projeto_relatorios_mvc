{% extends "base.html" %}

{% block title %}Analisador de Relatórios IA{% endblock %}

{% block content %}
<div class="container-fluid mt-lg-3">
    <div class="page-header text-center">
        <h1><i class="bi bi-shield-lock-fill me-2"></i>Analisador de Relatórios com IA</h1>
        <p class="lead text-muted">Cole o relatório bruto abaixo para processamento e correção.</p>
    </div>

    {% if current_user.is_authenticated %}
    <form method="POST" action="{{ url_for('main.index') }}" id="analisador-form" novalidate>
        
        {{ form.hidden_tag() }}

        <div class="row g-4 justify-content-center">

            <div class="col-12 col-lg-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex align-items-center">
                        <h5 class="mb-0"><i class="bi bi-keyboard me-2"></i>1. Relatório Bruto</h5>
                    </div>
                    <div class="card-body d-flex flex-column p-lg-4">
                        <div class="form-group mb-3 flex-grow-1">
                            {{ form.relatorio_bruto.label(class="form-label") }}
                            
                            {% if form.relatorio_bruto.errors %}
                                {{ form.relatorio_bruto(class="form-control is-invalid") }}
                                <div class="invalid-feedback">
                                    {% for error in form.relatorio_bruto.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {{ form.relatorio_bruto(class="form-control") }}
                            {% endif %}
                            <small id="charCount" class="form-text text-muted">Caracteres: 0 / 12000</small>
                        </div>
                        <div class="mt-auto d-grid gap-2">
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                            <button type="button" class="btn btn-outline-secondary" id="limpar-campos">
                                <i class="bi bi-eraser me-2"></i>Limpar Campos
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex align-items-center">
                        <h5 class="mb-0"><i class="bi bi-robot me-2"></i>2. Relatório Corrigido</h5>
                    </div>
                    <div class="card-body d-flex flex-column p-lg-4">
                        <div class="form-group mb-3 flex-grow-1">
                            <label for="resultadoProcessamento" class="form-label">Resultado da Análise:</label>
                            <textarea class="form-control" id="resultadoProcessamento" rows="18" readonly
                                placeholder="O resultado da análise aparecerá aqui...">{{ relatorio_corrigido or '' }}</textarea>
                        </div>
                        
                        {% if relatorio_corrigido %}
                        <div class="mt-auto d-flex flex-column flex-md-row gap-2">
                            <button type="button" class="btn btn-info w-100" id="copiarResultado" data-bs-toggle="tooltip" title="Copiar o texto corrigido">
                                <i class="bi bi-clipboard-check me-2"></i>Copiar
                            </button>
                            <a href="{{ url_for('ocorrencia.registrar_ocorrencia', relatorio_final=relatorio_corrigido) }}" class="btn btn-success w-100">
                                <i class="bi bi-box-arrow-up-right me-2"></i>Exportar para Ocorrência
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
    {% else %}
        <div class="alert alert-warning text-center" role="alert">
            Você precisa estar logado para usar esta funcionalidade.
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script type="module" src="{{ url_for('static', filename='js/index_page/main.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Inicializa tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // --- CORREÇÃO PARA O FEEDBACK "PROCESSANDO..." ---
    const form = document.getElementById('analisador-form');
    // O botão submit do Flask-WTF tem id 'submit' por padrão
    const submitButton = document.getElementById('submit'); 
    
    if (form && submitButton) {
        form.addEventListener('submit', function() {
            // Verifica se o formulário é válido do lado do cliente antes de mostrar o spinner
            // (Isso é opcional, pois o backend já valida, mas melhora a UX)
            if (form.checkValidity()) {
                submitButton.disabled = true;
                submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando...`;
            }
        });
    }

    // --- LÓGICA PARA O BOTÃO "LIMPAR CAMPOS" ---
    const btnLimpar = document.getElementById('limpar-campos');
    const relatorioBrutoEl = document.getElementById('relatorio_bruto');
    const resultadoEl = document.getElementById('resultadoProcessamento');
    const charCountEl = document.getElementById('charCount');

    if (btnLimpar) {
        btnLimpar.addEventListener('click', function() {
            if (relatorioBrutoEl) relatorioBrutoEl.value = '';
            if (resultadoEl) resultadoEl.value = '';
            if(charCountEl) {
                charCountEl.textContent = 'Caracteres: 0 / 12000';
            }
        });
    }
    
    // --- LÓGICA PARA O CONTADOR DE CARACTERES ---
    if (relatorioBrutoEl && charCountEl) {
        const updateCharCount = () => {
            charCountEl.textContent = `Caracteres: ${relatorioBrutoEl.value.length} / 12000`;
        };
        updateCharCount(); // Chama ao carregar a página
        relatorioBrutoEl.addEventListener('input', updateCharCount); // Chama ao digitar
    }

    // --- LÓGICA PARA O BOTÃO "COPIAR" ---
    const btnCopiar = document.getElementById('copiarResultado');
    if (btnCopiar) {
        btnCopiar.addEventListener('click', function() {
            // ... (lógica do botão copiar, sem alterações) ...
        });
    }
});
</script>
{% endblock %}