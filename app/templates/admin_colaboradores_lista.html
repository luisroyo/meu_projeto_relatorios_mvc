{% extends "base.html" %}

{% block title %}{{ title }} - Painel Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{{ title }}</h2>
        <a href="{{ url_for('admin.adicionar_colaborador') }}" class="btn btn-success">
            <i class="bi bi-plus-circle-fill me-2"></i>Adicionar Novo Colaborador
        </a>
    </div>
    <hr>

    {% if colaboradores_pagination.items %}
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome Completo</th>
                    <th>Cargo</th>
                    <th>Matrícula</th>
                    <th>Status</th>
                    <th>Admissão</th>
                    <th>Criado em</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for colab in colaboradores_pagination.items %}
                <tr>
                    <td>{{ colab.id }}</td>
                    <td>{{ colab.nome_completo }}</td>
                    <td>{{ colab.cargo }}</td>
                    <td>{{ colab.matricula if colab.matricula else '-' }}</td>
                    <td>
                        {% if colab.status == 'Ativo' %}
                            <span class="badge bg-success">{{ colab.status }}</span>
                        {% elif colab.status == 'Inativo' %}
                            <span class="badge bg-danger">{{ colab.status }}</span>
                        {% elif colab.status == 'Férias' %}
                            <span class="badge bg-info text-dark">{{ colab.status }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ colab.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ colab.data_admissao.strftime('%d/%m/%Y') if colab.data_admissao else '-' }}</td>
                    <td>{{ colab.data_criacao.strftime('%d/%m/%Y %H:%M') if colab.data_criacao else '-'}}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="{{ url_for('admin.editar_colaborador', colab_id=colab.id) }}" class="btn btn-outline-primary" title="Editar">
                                <i class="bi bi-pencil-square"></i> Editar
                            </a>
                            <form method="POST" action="{{ url_for('admin.deletar_colaborador', colab_id=colab.id) }}" style="display: inline-block;" onsubmit="return confirm('Tem certeza que deseja deletar este colaborador? Esta ação não pode ser desfeita.');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/> {# Para proteção CSRF se habilitada globalmente #}
                                <button type="submit" class="btn btn-outline-danger" title="Deletar">
                                    <i class="bi bi-trash-fill"></i> Deletar
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Paginação #}
    {% if colaboradores_pagination.pages > 1 %}
    <nav aria-label="Paginação de Colaboradores" class="mt-4">
        <ul class="pagination justify-content-center">
            {# Link para Anterior #}
            <li class="page-item {% if not colaboradores_pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin.listar_colaboradores', page=colaboradores_pagination.prev_num) if colaboradores_pagination.has_prev else '#_'}">Anterior</a>
            </li>

            {# Links das Páginas #}
            {% for page_num in colaboradores_pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if colaboradores_pagination.page == page_num %}
                        <li class="page-item active" aria-current="page"><span class="page-link">{{ page_num }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('admin.listar_colaboradores', page=page_num) }}">{{ page_num }}</a></li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            {# Link para Próxima #}
            <li class="page-item {% if not colaboradores_pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin.listar_colaboradores', page=colaboradores_pagination.next_num) if colaboradores_pagination.has_next else '#_'}">Próxima</a>
            </li>
        </ul>
    </nav>
    {% endif %}

    {% else %}
        <div class="alert alert-info mt-3">Nenhum colaborador cadastrado ainda. <a href="{{ url_for('admin.adicionar_colaborador') }}">Adicione o primeiro!</a></div>
    {% endif %}

    <div class="mt-4">
        <a href="{{ url_for('admin.admin_tools') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i>Voltar para Ferramentas Admin
        </a>
    </div>
</div>
{% endblock %}
```

**4.2. `app/templates/admin_colaborador_form.html`** (para adicionar/editar colaborador)
Crie este novo arquivo.


```html
{% extends "base.html" %}
{% from "_form_macros.html" import render_field %} {# Opcional, para renderizar campos de formulário #}

{% block title %}{{ title }} - Painel Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3 class="mb-0">{{ title }}</h3>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ form_action }}" novalidate>
                        {{ form.hidden_tag() }} {# CSRF token #}
                        
                        <div class="mb-3">
                            {{ form.nome_completo.label(class="form-label") }}
                            {{ form.nome_completo(class="form-control form-control-lg" + (" is-invalid" if form.nome_completo.errors else "")) }}
                            {% if form.nome_completo.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.nome_completo.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.cargo.label(class="form-label") }}
                            {{ form.cargo(class="form-control form-control-lg" + (" is-invalid" if form.cargo.errors else "")) }}
                            {% if form.cargo.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.cargo.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.matricula.label(class="form-label") }}
                            {{ form.matricula(class="form-control form-control-lg" + (" is-invalid" if form.matricula.errors else ""), placeholder="Opcional") }}
                            {% if form.matricula.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.matricula.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.data_admissao.label(class="form-label") }}
                            {# Para DateField, o valor precisa ser formatado se vier do objeto colaborador #}
                            {{ form.data_admissao(class="form-control form-control-lg" + (" is-invalid" if form.data_admissao.errors else ""), value=colaborador.data_admissao.strftime('%Y-%m-%d') if colaborador and colaborador.data_admissao else form.data_admissao.data) }}
                            {% if form.data_admissao.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.data_admissao.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.status.label(class="form-label") }}
                            {{ form.status(class="form-select form-select-lg" + (" is-invalid" if form.status.errors else "")) }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.status.errors %}<span>{{ error }}</span><br>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-grid mt-4">
                            {{ form.submit(class="btn btn-success btn-lg") }}
                        </div>
                    </form>
                </div>
            </div>
            <div class="mt-4 text-center">
                <a href="{{ url_for('admin.listar_colaboradores') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg me-1"></i>Cancelar e Voltar para Lista
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
```

---
**Passo 5: Adicionar Link para Gerenciar Colaboradores no Dashboard de Ferramentas**
---
Edite o `app/templates/admin_ferramentas.html` (Canvas ID: `admin_tools_dashboard_html`) para incluir um link ou cartão para a nova seção de gerenciamento de colaboradores. Você já fez isso na versão anterior, mas aqui está para confirmar:


```html
{% extends "base.html" %}

{% block title %}{{ title }} - Painel Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="page-header mb-4">
        <h2 class="text-center">{{ title }}</h2>
        <p class="lead text-center">Selecione uma ferramenta ou funcionalidade abaixo.</p>
    </div>
    <hr>

    <ul class="nav nav-tabs nav-fill mb-3" id="adminToolsTab" role="tablist">
        {# ... (suas abas existentes como Analisador Geral, Relatório de Ronda, Formatar E-mail) ... #}
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="analisador-geral-tab" data-bs-toggle="tab" data-bs-target="#analisador-geral-content" type="button" role="tab" aria-controls="analisador-geral-content" aria-selected="true">
                <i class="bi bi-robot me-1"></i>Analisador Geral de Relatórios
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="relatorio-ronda-tab" data-bs-toggle="tab" data-bs-target="#relatorio-ronda-content" type="button" role="tab" aria-controls="relatorio-ronda-content" aria-selected="false">
                <i class="bi bi-shield-check me-1"></i>Relatório de Ronda Específico
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="formatar-email-tab" data-bs-toggle="tab" data-bs-target="#formatar-email-content" type="button" role="tab" aria-controls="formatar-email-content" aria-selected="false">
                <i class="bi bi-envelope-check-fill me-1"></i>Formatar para E-mail
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="outras-ferramentas-tab" data-bs-toggle="tab" data-bs-target="#outras-ferramentas-content" type="button" role="tab" aria-controls="outras-ferramentas-content" aria-selected="false">
                <i class="bi bi-grid-1x2-fill me-1"></i>Outras Ferramentas e Gestão
            </button>
        </li>
    </ul>

    <div class="tab-content" id="adminToolsTabContent">
        {# ... (conteúdo das suas abas existentes) ... #}
        <div class="tab-pane fade show active" id="analisador-geral-content" role="tabpanel" aria-labelledby="analisador-geral-tab" tabindex="0">
            {# ... Conteúdo do Analisador Geral ... #}
             <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Analisador de Relatórios com IA (Geral)</h5></div>
                <div class="card-body p-4">
                    <p class="lead">Cole o relatório bruto abaixo para processamento e correção pela Inteligência Artificial.</p>
                    <div class="row">
                        <div class="col-12 col-md-6 mb-4">
                            <div class="card h-100"> 
                                <div class="card-header"><h6 class="mb-0">Entrada do Relatório</h6></div>
                                <div class="card-body d-flex flex-column"> 
                                    <div class="form-group mb-3 flex-grow-1"> 
                                        <label for="relatorioBrutoGeral" class="form-label">Relatório Bruto:</label>
                                        <textarea class="form-control" id="relatorioBrutoGeral" name="relatorioBrutoGeral" rows="15" placeholder="Cole o relatório bruto aqui..."></textarea>
                                        <small id="charCountGeral" class="form-text text-muted">Caracteres: 0 / 12000</small>
                                    </div>
                                    <div class="mt-auto"><div class="d-grid gap-2 d-sm-flex justify-content-sm-start">
                                        <button type="button" class="btn btn-primary btn-lg mb-2 mb-sm-0 me-sm-2 flex-grow-1 flex-sm-grow-0" id="processarRelatorioGeral">
                                            <span id="processarSpinnerGeral" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span> Processar Relatório
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-lg flex-grow-1 flex-sm-grow-0" id="limparCamposGeral">Limpar Tudo</button>
                                    </div></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header"><h6 class="mb-0">Relatório Processado</h6></div>
                                <div class="card-body d-flex flex-column">
                                    <div id="statusProcessamentoGeral" class="mb-3"></div>
                                    <div class="form-group mb-3 flex-grow-1">
                                        <label for="resultadoProcessamentoGeral" class="form-label">Resultado:</label>
                                        <textarea class="form-control" id="resultadoProcessamentoGeral" rows="15" readonly placeholder="O relatório processado aparecerá aqui..."></textarea>
                                    </div>
                                    <div class="mt-auto"><button type="button" class="btn btn-info btn-lg" id="copiarResultadoGeral" style="display: none;" data-bs-toggle="tooltip" data-bs-placement="top" title="Copiar para a área de transferência">Copiar Resultado</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="relatorio-ronda-content" role="tabpanel" aria-labelledby="relatorio-ronda-tab" tabindex="0">
            {# ... Conteúdo do Relatório de Ronda Específico (formulário) ... #}
             <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Gerar Relatório de Ronda Específico</h5></div>
                <div class="card-body p-4">
                    <p class="lead">Insira os dados do plantão e o log bruto das rondas para gerar o relatório formatado.</p>
                    <form method="POST" action="{{ url_for('ronda.relatorio_ronda') }}" novalidate id="formRelatorioRondaTab">
                        {{ ronda_form.hidden_tag() }}
                        <div class="mb-3">{{ ronda_form.nome_condominio.label(class="form-label") }} {{ ronda_form.nome_condominio(class="form-select" + (" is-invalid" if ronda_form.nome_condominio.errors else ""), id="nome_condominio_select_tab") }} {% if ronda_form.nome_condominio.errors %}<div class="invalid-feedback d-block">{% for error in ronda_form.nome_condominio.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}</div>
                        <div class="mb-3" id="outro_condominio_div_tab" {% if ronda_form.nome_condominio.data != 'Outro' or not ronda_form.nome_condominio_outro.data %}style="display: none;"{% endif %}> {{ ronda_form.nome_condominio_outro.label(class="form-label") }} {{ ronda_form.nome_condominio_outro(class="form-control" + (" is-invalid" if ronda_form.nome_condominio_outro.errors else ""), placeholder="Digite o nome do condomínio", id="nome_condominio_outro_input_tab") }} {% if ronda_form.nome_condominio_outro.errors %}<div class="invalid-feedback d-block">{% for error in ronda_form.nome_condominio_outro.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}</div>
                        <div class="mb-3">{{ ronda_form.data_plantao.label(class="form-label") }} {{ ronda_form.data_plantao(class="form-control" + (" is-invalid" if ronda_form.data_plantao.errors else ""), id="data_plantao_input_tab") }} {% if ronda_form.data_plantao.errors %}<div class="invalid-feedback d-block">{% for error in ronda_form.data_plantao.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}</div>
                        <div class="mb-3">{{ ronda_form.escala_plantao.label(class="form-label") }} {{ ronda_form.escala_plantao(class="form-select" + (" is-invalid" if ronda_form.escala_plantao.errors else ""), id="escala_plantao_select_tab") }} {% if ronda_form.escala_plantao.errors %}<div class="invalid-feedback d-block">{% for error in ronda_form.escala_plantao.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}</div>
                        <div class="mb-3">{{ ronda_form.log_bruto_rondas.label(class="form-label") }} {{ ronda_form.log_bruto_rondas(class="form-control" + (" is-invalid" if ronda_form.log_bruto_rondas.errors else ""), rows="10", id="log_bruto_rondas_textarea_tab") }} {% if ronda_form.log_bruto_rondas.errors %}<div class="invalid-feedback d-block">{% for error in ronda_form.log_bruto_rondas.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}</div>
                        <div class="mt-auto"><div class="d-flex flex-column flex-sm-row"> {{ ronda_form.submit(class="btn btn-primary btn-lg mb-2 mb-sm-0 me-sm-2 w-100 w-sm-auto", id="submitRelatorioRondaTab") }} <button type="button" class="btn btn-outline-secondary btn-lg w-100 w-sm-auto" id="limparFormRondaTab">Limpar Log</button> </div></div>
                    </form>
                    <p class="mt-3"><small>Nota: Após submeter, o relatório completo será exibido em uma nova página.</small></p>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="formatar-email-content" role="tabpanel" aria-labelledby="formatar-email-tab" tabindex="0">
            {# ... Conteúdo do Formatar E-mail (formulário) ... #}
            <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Formatar Relatório para E-mail</h5></div>
                <div class="card-body p-4">
                    <p>Cole o relatório gerado, selecione as opções e formate o texto para envio.</p>
                    <form method="POST" action="{{ url_for('admin.admin_tools') }}#formatar-email-content" novalidate>
                        {{ email_form.hidden_tag() }} <input type="hidden" name="tool_action" value="format_email">
                        <div class="mb-3"> {{ email_form.raw_report.label(class="form-label") }} {{ email_form.raw_report(class="form-control form-control-lg" + (" is-invalid" if email_form.raw_report.errors else ""), rows="12") }} {% if email_form.raw_report.errors %}<div class="invalid-feedback d-block">{% for error in email_form.raw_report.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}</div>
                        <h6 class="mt-4 mb-3"><i class="bi bi-sliders me-2"></i>Opções de Formatação:</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check mb-2">{{ email_form.include_greeting(class="form-check-input", id="include_greeting_checkbox_email") }} {{ email_form.include_greeting.label(class="form-check-label", for="include_greeting_checkbox_email") }}</div>
                                <div class="mb-3 ps-4">{{ email_form.custom_greeting.label(class="form-label form-label-sm") }} {{ email_form.custom_greeting(class="form-control form-control-sm" + (" is-invalid" if email_form.custom_greeting.errors else ""), rows="2", id="custom_greeting_text_email") }} {% if email_form.custom_greeting.errors %}<div class="invalid-feedback d-block">{% for error in email_form.custom_greeting.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">{{ email_form.include_closing(class="form-check-input", id="include_closing_checkbox_email") }} {{ email_form.include_closing.label(class="form-check-label", for="include_closing_checkbox_email") }}</div>
                                <div class="mb-3 ps-4">{{ email_form.custom_closing.label(class="form-label form-label-sm") }} {{ email_form.custom_closing(class="form-control form-control-sm" + (" is-invalid" if email_form.custom_closing.errors else ""), rows="2", id="custom_closing_text_email") }} {% if email_form.custom_closing.errors %}<div class="invalid-feedback d-block">{% for error in email_form.custom_closing.errors %}<span>{{ error }}</span><br>{% endfor %}</div>{% endif %}</div>
                            </div>
                        </div>
                        <div class="d-grid mt-4">{{ email_form.submit(class="btn btn-primary btn-lg", id="submitFormatEmail") }}</div>
                    </form>
                    {% if formatted_email_report %}
                    <hr class="my-4">
                    <h5><i class="bi bi-check2-square me-2"></i>Relatório Formatado para E-mail:</h5>
                    <div class="p-3 bg-light border rounded mb-3"><pre id="formattedEmailReportText" style="white-space: pre-wrap; word-wrap: break-word;">{{ formatted_email_report }}</pre></div>
                    <button type="button" class="btn btn-secondary" id="copyFormattedEmailReport" data-bs-toggle="tooltip" data-bs-placement="top" title="Copiar para a área de transferência"><i class="bi bi-clipboard-check me-1"></i>Copiar Texto Formatado</button>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="outras-ferramentas-content" role="tabpanel" aria-labelledby="outras-ferramentas-tab" tabindex="0">
            <div class="card shadow-sm">
                <div class="card-header"><h5 class="mb-0">Outras Ferramentas e Gestão</h5></div>
                <div class="card-body p-4">
                    <div class="list-group">
                        <a href="{{ url_for('admin.manage_users') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-people-fill me-2"></i>Gerenciar Contas de Usuários
                        </a>
                        {# LINK PARA GERENCIAR COLABORADORES #}
                        <a href="{{ url_for('admin.listar_colaboradores') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-person-badge-fill me-2"></i>Gerenciar Colaboradores (Equipe)
                        </a>
                        <a href="{{ url_for('admin.gerador_justificativas_tool') }}" class="list-group-item list-group-item-action">
                            <i class="bi bi-file-earmark-text-fill me-2"></i>Gerador de Justificativas (iFractal)
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{# ... (Seu JavaScript existente para as abas Analisador Geral, Formatar E-mail, e persistência de aba) ... #}
{{ super() }}
<script>
    // Passa URLs e tokens do Flask/Jinja2 para o JavaScript externo
    const justificativaApiUrl = "{{ url_for('admin.api_processar_justificativa') }}"; // Para o Gerador de Justificativas
    const csrfToken = "{{ csrf_token() if csrf_token else '' }}"; 
    const processarRelatorioGeralUrl = "{{ url_for('ronda.processar_relatorio') }}"; // Para o Analisador Geral
    // A lista de colaboradores será usada pelo admin_justificativas.js se você o adaptar
    const listaColaboradores = {{ colaboradores_json|tojson|safe if colaboradores_json else '[]' }}; 
</script>
{# JavaScript para o Analisador Geral (que estava no index.html) #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Só executa o código do Analisador Geral se os elementos existirem
    const relatorioBrutoGeralTextarea = document.getElementById('relatorioBrutoGeral');
    if (relatorioBrutoGeralTextarea) {
        const charCountGeralElement = document.getElementById('charCountGeral');
        const processarRelatorioGeralButton = document.getElementById('processarRelatorioGeral');
        const resultadoProcessamentoGeralTextarea = document.getElementById('resultadoProcessamentoGeral');
        const limparCamposGeralButton = document.getElementById('limparCamposGeral');
        const copiarResultadoGeralButton = document.getElementById('copiarResultadoGeral');
        const processarSpinnerGeral = document.getElementById('processarSpinnerGeral');
        const statusProcessamentoGeralDiv = document.getElementById('statusProcessamentoGeral');
        const MAX_CHARS_GERAL = current_app.config.get('MAX_RELATORIO_INPUT_LENGTH', 12000);


        if (relatorioBrutoGeralTextarea && charCountGeralElement) {
            relatorioBrutoGeralTextarea.addEventListener('input', function () {
                const currentChars = this.value.length;
                charCountGeralElement.textContent = `Caracteres: ${currentChars} / ${MAX_CHARS_GERAL}`;
                charCountGeralElement.classList.toggle('text-danger', currentChars > MAX_CHARS_GERAL);
            });
             // Inicializa a contagem de caracteres
            charCountGeralElement.textContent = `Caracteres: ${relatorioBrutoGeralTextarea.value.length} / ${MAX_CHARS_GERAL}`;

        }

        if (processarRelatorioGeralButton) {
            processarRelatorioGeralButton.addEventListener('click', function() {
                const relatorioBruto = relatorioBrutoGeralTextarea.value;
                if (!relatorioBruto.trim()) {
                    statusProcessamentoGeralDiv.innerHTML = '<div class="alert alert-warning">Por favor, insira o relatório bruto.</div>';
                    return;
                }
                if (relatorioBruto.length > MAX_CHARS_GERAL) {
                    statusProcessamentoGeralDiv.innerHTML = `<div class="alert alert-danger">Relatório muito longo. Máximo de ${MAX_CHARS_GERAL} caracteres.</div>`;
                    return;
                }
                processarSpinnerGeral.style.display = 'inline-block';
                processarRelatorioGeralButton.disabled = true;
                statusProcessamentoGeralDiv.innerHTML = '<div class="alert alert-info">Processando...</div>';
                resultadoProcessamentoGeralTextarea.value = '';
                copiarResultadoGeralButton.style.display = 'none';

                fetch(processarRelatorioGeralUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ relatorio_bruto: relatorioBruto })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.relatorio_processado) {
                        resultadoProcessamentoGeralTextarea.value = data.relatorio_processado;
                        copiarResultadoGeralButton.style.display = 'inline-block';
                        statusProcessamentoGeralDiv.innerHTML = '<div class="alert alert-success">Relatório processado com sucesso!</div>';
                    } else if (data.erro) {
                        statusProcessamentoGeralDiv.innerHTML = `<div class="alert alert-danger">Erro: ${data.erro}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Erro na requisição AJAX (Analisador Geral):', error);
                    statusProcessamentoGeralDiv.innerHTML = '<div class="alert alert-danger">Erro na comunicação com o servidor. Tente novamente.</div>';
                })
                .finally(() => {
                    processarSpinnerGeral.style.display = 'none';
                    processarRelatorioGeralButton.disabled = false;
                });
            });
        }
        if (limparCamposGeralButton) {
            limparCamposGeralButton.addEventListener('click', function() {
                relatorioBrutoGeralTextarea.value = '';
                resultadoProcessamentoGeralTextarea.value = '';
                if(charCountGeralElement) {
                    charCountGeralElement.textContent = `Caracteres: 0 / ${MAX_CHARS_GERAL}`;
                    charCountGeralElement.classList.remove('text-danger');
                }
                if(copiarResultadoGeralButton) copiarResultadoGeralButton.style.display = 'none';
                if(statusProcessamentoGeralDiv) statusProcessamentoGeralDiv.innerHTML = '';
            });
        }
        if (copiarResultadoGeralButton && resultadoProcessamentoGeralTextarea) {
            var tooltipCG = new bootstrap.Tooltip(copiarResultadoGeralButton);
            copiarResultadoGeralButton.addEventListener('click', function() {
                resultadoProcessamentoGeralTextarea.select();
                navigator.clipboard.writeText(resultadoProcessamentoGeralTextarea.value).then(() => {
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copiado!';
                    this.setAttribute('data-bs-original-title', 'Copiado!');
                    tooltipCG.show();
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.setAttribute('data-bs-original-title', 'Copiar para a área de transferência');
                        tooltipCG.hide();
                    }, 2000);
                }).catch(err => {
                    console.error('Falha ao copiar (Analisador Geral): ', err);
                    alert('Falha ao copiar. Por favor, selecione e copie manualmente.');
                });
            });
        }
    } // Fim do if (relatorioBrutoGeralTextarea)

    // --- Lógica para o Relatório de Ronda Específico (Aba 2) ---
    const selectCondominioTab = document.getElementById('nome_condominio_select_tab');
    if (selectCondominioTab) { // Só executa se o elemento existir
        const outroCondominioDivTab = document.getElementById('outro_condominio_div_tab');
        const outroCondominioInputTab = document.getElementById('nome_condominio_outro_input_tab');
        const logBrutoRondasTextareaTab = document.getElementById('log_bruto_rondas_textarea_tab');
        const btnLimparFormRondaTab = document.getElementById('limparFormRondaTab');

        function toggleOutroCondominioTab() {
            if (selectCondominioTab && outroCondominioDivTab) {
                outroCondominioDivTab.style.display = (selectCondominioTab.value === 'Outro') ? 'block' : 'none';
                if (selectCondominioTab.value !== 'Outro' && outroCondominioInputTab) {
                    outroCondominioInputTab.value = ''; 
                }
            }
        }
        selectCondominioTab.addEventListener('change', toggleOutroCondominioTab);
        toggleOutroCondominioTab(); 

        if (btnLimparFormRondaTab && logBrutoRondasTextareaTab) {
            btnLimparFormRondaTab.addEventListener('click', function() {
                logBrutoRondasTextareaTab.value = ''; 
            });
        }
    } // Fim do if (selectCondominioTab)


    // --- Lógica para Formatar E-mail (Aba 3) ---
    const copyFormattedEmailButton = document.getElementById('copyFormattedEmailReport');
    if(copyFormattedEmailButton) { // Só executa se o elemento existir
        const formattedEmailReportTextElement = document.getElementById('formattedEmailReportText');
        if (formattedEmailReportTextElement) {
            var tooltipCopiarEmail = new bootstrap.Tooltip(copyFormattedEmailButton);
            copyFormattedEmailButton.addEventListener('click', function () {
                const textToCopy = formattedEmailReportTextElement.innerText || formattedEmailReportTextElement.textContent;
                navigator.clipboard.writeText(textToCopy).then(function () {
                    const originalText = copyFormattedEmailButton.innerHTML;
                    copyFormattedEmailButton.innerHTML = '<i class="bi bi-check-lg me-1"></i>Copiado!';
                    copyFormattedEmailButton.setAttribute('data-bs-original-title', 'Copiado!');
                    tooltipCopiarEmail.show();
                    setTimeout(function () {
                        copyFormattedEmailButton.innerHTML = originalText;
                        copyFormattedEmailButton.setAttribute('data-bs-original-title', 'Copiar para a área de transferência');
                        tooltipCopiarEmail.hide();
                    }, 2500);
                }).catch(function (err) {
                    console.error('Erro ao copiar texto do e-mail: ', err);
                    alert('Falha ao copiar. Por favor, selecione e copie manualmente.');
                });
            });
        }
    } // Fim do if(copyFormattedEmailButton)

    const includeGreetingCheckboxEmail = document.getElementById('include_greeting_checkbox_email');
    const customGreetingTextareaEmail = document.getElementById('custom_greeting_text_email');
    const includeClosingCheckboxEmail = document.getElementById('include_closing_checkbox_email');
    const customClosingTextareaEmail = document.getElementById('custom_closing_text_email');

    function setupToggleEmail(checkbox, textarea) {
        if (checkbox && textarea) {
            function toggleTextarea() {
                textarea.disabled = !checkbox.checked;
                if (!checkbox.checked) textarea.value = '';
            }
            checkbox.addEventListener('change', toggleTextarea);
            toggleTextarea();
        }
    }
    setupToggleEmail(includeGreetingCheckboxEmail, customGreetingTextareaEmail);
    setupToggleEmail(includeClosingCheckboxEmail, customClosingTextareaEmail);

    // Ativar a aba correta se houver um resultado de formatação de e-mail (após POST)
    {% if formatted_email_report %}
        var tabToActivateEmail = document.getElementById('formatar-email-tab');
        if (tabToActivateEmail) {
            var tabEmail = new bootstrap.Tab(tabToActivateEmail);
            tabEmail.show();
            var resultElementEmail = document.getElementById('formattedEmailReportText');
            if (resultElementEmail) {
                resultElementEmail.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    {% endif %}

    // Persistir aba ativa usando sessionStorage
    const adminToolsTab = document.getElementById('adminToolsTab');
    if (adminToolsTab) {
        const tabButtons = adminToolsTab.querySelectorAll('button[data-bs-toggle="tab"]');
        const activeTabIdSession = sessionStorage.getItem('activeAdminToolTab');
        
        // Ativa a aba de formatação de email se houver um resultado, senão tenta a da sessão
        if (!document.getElementById('formatar-email-tab').classList.contains('active') && activeTabIdSession) {
             const tabToActivateFromSession = document.getElementById(activeTabIdSession);
             if (tabToActivateFromSession) {
                 var tabSession = new bootstrap.Tab(tabToActivateFromSession);
                 tabSession.show();
             }
        } else if (!activeTabIdSession && !document.getElementById('formatar-email-tab').classList.contains('active')) {
            // Se nenhuma aba está ativa (nem por resultado de POST, nem por sessão), ativa a primeira
            const firstTabButton = adminToolsTab.querySelector('button[data-bs-toggle="tab"]');
            if (firstTabButton) {
                var firstTab = new bootstrap.Tab(firstTabButton);
                firstTab.show();
            }
        }

        tabButtons.forEach(button => {
            button.addEventListener('shown.bs.tab', function (event) {
                sessionStorage.setItem('activeAdminToolTab', event.target.id);
            });
        });
    }
});
</script>
{# Link para o JavaScript específico do Gerador de Justificativas #}
<script src="{{ url_for('static', filename='js/admin_justificativas.js') }}"></script>
{% endblock %}
