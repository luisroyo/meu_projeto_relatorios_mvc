{% extends "base.html" %}

{% block title %}{{ title }} - Assistente IA{% endblock %}

{% block content %}
<div class="container-fluid mt-lg-3">
    <div class="page-header text-center mb-4">
        <h1><i class="bi bi-shield-check me-2"></i>{{ title }}</h1>
        <p class="lead text-muted">Analise o desempenho e as tendências das rondas contratuais.</p>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-filter"></i> Filtros do Dashboard</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.ronda_dashboard') }}">
                <div class="row g-3">
                    <div class="col-md-3 col-sm-6">
                        <label for="data_inicio" class="form-label">De:</label>
                        <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ selected_data_inicio_str or '' }}">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="data_fim" class="form-label">Até:</label>
                        <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ selected_data_fim_str or '' }}">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="supervisor_id" class="form-label">Supervisor:</label>
                        <select class="form-select" id="supervisor_id" name="supervisor_id">
                            <option value="">-- Todos --</option>
                            {% for supervisor in supervisors %}
                            <option value="{{ supervisor.id }}" {% if supervisor.id == selected_supervisor_id %}selected{% endif %}>{{ supervisor.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="condominio_id" class="form-label">Condomínio:</label>
                        <select class="form-select" id="condominio_id" name="condominio_id">
                            <option value="">-- Todos --</option>
                            {% for condominio in condominios %}
                            <option value="{{ condominio.id }}" {% if condominio.id == selected_condominio_id %}selected{% endif %}>{{ condominio.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="turno" class="form-label">Turno:</label>
                        <select class="form-select" id="turno" name="turno">
                            <option value="">-- Todos --</option>
                            {% for t in turnos %}
                            <option value="{{ t }}" {% if t == selected_turno %}selected{% endif %}>{{ t }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="data_especifica" class="form-label fw-bold">Analisar Dia Específico:</label>
                        <input type="date" class="form-control" id="data_especifica" name="data_especifica" value="{{ selected_data_especifica or '' }}">
                    </div>
                    <div class="col-md-3 col-sm-12 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100 me-2">Filtrar</button>
                        <a href="{{ url_for('admin.ronda_dashboard') }}" class="btn btn-secondary w-100">Limpar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-start border-primary border-4 shadow-sm h-100 py-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">Total de Rondas (no período)</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ total_rondas }}</div>
                        </div>
                        <div class="col-auto"><i class="bi bi-shield-check fs-2 text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-start border-success border-4 shadow-sm h-100 py-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">Duração Média Geral (min)</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ duracao_media_geral }}</div>
                        </div>
                        <div class="col-auto"><i class="bi bi-clock-history fs-2 text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-start border-info border-4 shadow-sm h-100 py-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">Supervisor Mais Ativo</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ supervisor_mais_ativo }}</div>
                        </div>
                        <div class="col-auto"><i class="bi bi-person-star fs-2 text-gray-300"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if total_rondas > 0 %}

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Atividade de Rondas ao Longo do Tempo</div>
                <div class="card-body">
                    <canvas id="rondaActivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Total de Rondas por Supervisor</div>
                <div class="card-body">
                    <canvas id="rondasPorSupervisorChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Total de Rondas por Condomínio</div>
                <div class="card-body">
                    <canvas id="rondasPorCondominioChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Duração Média (min) por Ronda</div>
                <div class="card-body">
                    <canvas id="duracaoMediaChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Total de Rondas por Turno</div>
                <div class="card-body">
                    <canvas id="rondasPorTurnoChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning text-center" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Nenhum dado de ronda encontrado para os filtros selecionados.
            </div>
        </div>
    </div>
    {% endif %}

    {% if selected_data_especifica and dados_tabela_dia %}
    <hr class="my-4">
    <div class="row mt-4">
        <div class="col-12 text-center mb-3">
            <h4>Análise Detalhada para o Dia {{ selected_data_especifica|format_date }}</h4>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Rondas por Turno no Dia</div>
                <div class="card-body">
                    <canvas id="rondasPorTurnoDiaChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Detalhes por Supervisor no Dia</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Supervisor</th>
                                    <th>Turno</th>
                                    <th>Total de Rondas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in dados_tabela_dia %}
                                <tr>
                                    <td>{{ item.username }}</td>
                                    <td>{{ item.turno_ronda }}</td>
                                    <td>{{ item[2] }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const barColors = ['rgba(54, 162, 235, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'];
    const barBorders = ['rgb(54, 162, 235)', 'rgb(75, 192, 192)', 'rgb(255, 206, 86)', 'rgb(255, 99, 132)', 'rgb(153, 102, 255)', 'rgb(255, 159, 64)'];

    const renderChart = (ctx, type, labels, data, label, backgroundColor, borderColor) => {
        if (!ctx) return;
        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{ label: label, data: data, backgroundColor: backgroundColor, borderColor: borderColor, borderWidth: 1, tension: 0.1 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: type === 'line' || type === 'pie' } },
                scales: { y: { beginAtZero: true } }
            }
        });
    };
    
    // Renderiza gráficos principais apenas se houver dados
    if ({{ total_rondas or 0 }} > 0) {
        renderChart(document.getElementById('rondaActivityChart')?.getContext('2d'), 'line', {{ ronda_date_labels | tojson }}, {{ ronda_activity_data | tojson }}, 'Total de Rondas por Dia', barColors[0], barBorders[0]);
        renderChart(document.getElementById('rondasPorSupervisorChart')?.getContext('2d'), 'bar', {{ supervisor_labels | tojson }}, {{ rondas_por_supervisor_data | tojson }}, '# de Rondas', barColors, barBorders);
        renderChart(document.getElementById('rondasPorCondominioChart')?.getContext('2d'), 'bar', {{ condominio_labels | tojson }}, {{ rondas_por_condominio_data | tojson }}, '# de Rondas', barColors, barBorders);
        renderChart(document.getElementById('duracaoMediaChart')?.getContext('2d'), 'bar', {{ duracao_condominio_labels | tojson }}, {{ duracao_media_data | tojson }}, 'Duração Média (min)', barColors, barBorders);
        renderChart(document.getElementById('rondasPorTurnoChart')?.getContext('2d'), 'pie', {{ turno_labels | tojson }}, {{ rondas_por_turno_data | tojson }}, '# de Rondas', barColors, barBorders);
    }

    // Renderiza gráfico de dia específico
    const dadosDiaDetalhado = {{ dados_dia_detalhado | tojson or '{}' }};
    if (dadosDiaDetalhado.labels && dadosDiaDetalhado.labels.length > 0) {
        renderChart(document.getElementById('rondasPorTurnoDiaChart')?.getContext('2d'), 'pie', dadosDiaDetalhado.labels, dadosDiaDetalhado.data, '# de Rondas', barColors, barBorders);
    }
});
</script>
{% endblock %}