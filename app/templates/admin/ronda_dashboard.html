{# app/templates/admin/ronda_dashboard.html #}
{% extends "base.html" %}

{% block title %}{{ title }} - Assistente IA{% endblock %}

{% block content %}
<div class="container-fluid mt-lg-3">
    <div class="page-header text-center mb-4">
        <h1><i class="bi bi-graph-up-arrow me-2"></i>{{ title }}</h1>
        <p class="lead text-muted">Analise o desempenho e as tendências das rondas.</p>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-filter"></i> Filtros do Dashboard</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin.ronda_dashboard') }}">
                <div class="row g-3">
                    <div class="col-md-3 col-sm-6">
                        <label for="data_inicio" class="form-label">De:</label>
                        <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ selected_data_inicio or '' }}">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="data_fim" class="form-label">Até:</label>
                        <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ selected_data_fim or '' }}">
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="supervisor_id" class="form-label">Supervisor:</label>
                        <select class="form-select" id="supervisor_id" name="supervisor_id">
                            <option value="">-- Todos --</option>
                            {% for supervisor in supervisors %}
                            <option value="{{ supervisor.id }}" {% if supervisor.id == selected_supervisor_id %}selected{% endif %}>{{ supervisor.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                     <div class="col-md-3 col-sm-6">
                        <label for="condominio_id" class="form-label">Condomínio:</label>
                        <select class="form-select" id="condominio_id" name="condominio_id">
                            <option value="">-- Todos --</option>
                            {% for condominio in condominios %}
                            <option value="{{ condominio.id }}" {% if condominio.id == selected_condominio_id %}selected{% endif %}>{{ condominio.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="turno" class="form-label">Turno:</label>
                        <select class="form-select" id="turno" name="turno">
                            <option value="">-- Todos --</option>
                            {% for t in turnos %}
                            <option value="{{ t }}" {% if t == selected_turno %}selected{% endif %}>{{ t }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label for="data_especifica" class="form-label fw-bold">Analisar Dia Específico:</label>
                        <input type="date" class="form-control" id="data_especifica" name="data_especifica" value="{{ selected_data_especifica or '' }}">
                    </div>
                    <div class="col-md-3 col-sm-12 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100 me-2">Filtrar</button>
                        <a href="{{ url_for('admin.ronda_dashboard') }}" class="btn btn-secondary w-100">Limpar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {# NOVO: Ranking de Confiabilidade dos Supervisores #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-award me-2"></i>Ranking de Confiabilidade dos Supervisores</h5>
                </div>
                <div class="card-body">
                    {% if supervisor_ranking %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Supervisor</th>
                                    <th class="text-center">Total Rondas</th>
                                    <th class="text-center">Incompletas</th>
                                    <th class="text-center">Duração Anômala</th>
                                    <th class="text-center">Total Problemáticas</th>
                                    <th class="text-center">Percentual Problemático</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rank_item in supervisor_ranking %}
                                <tr>
                                    <td>{{ rank_item.supervisor_nome }}</td>
                                    <td class="text-center">{{ rank_item.total_rondas }}</td>
                                    <td class="text-center">
                                        {% if rank_item.rondas_incompletas > 0 %}
                                            <i class="bi bi-exclamation-triangle-fill text-warning" title="{{ rank_item.rondas_incompletas }} rondas incompletas"></i> {{ rank_item.rondas_incompletas }}
                                        {% else %}
                                            <i class="bi bi-check-circle-fill text-success"></i> 0
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if rank_item.rondas_anomalas_duracao > 0 %}
                                            <i class="bi bi-exclamation-triangle-fill text-warning" title="{{ rank_item.rondas_anomalas_duracao }} rondas com duração anômala"></i> {{ rank_item.rondas_anomalas_duracao }}
                                        {% else %}
                                            <i class="bi bi-check-circle-fill text-success"></i> 0
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if rank_item.total_rondas_problematicas > 0 %}
                                            <span class="badge bg-danger">{{ rank_item.total_rondas_problematicas }}</span>
                                        {% else %}
                                            <span class="badge bg-success">0</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if rank_item.percentual_problematicas > 0 %}
                                            <span class="badge bg-danger">{{ "%.2f"|format(rank_item.percentual_problematicas) }}%</span>
                                        {% else %}
                                            <span class="badge bg-success">0.00%</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Nenhum dado de ranking de supervisor encontrado com os filtros aplicados.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Gráficos da visão geral #}
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Total de Rondas por Supervisor</div>
                <div class="card-body">
                    <canvas id="rondasPorSupervisorChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Total de Rondas por Condomínio</div>
                <div class="card-body">
                    <canvas id="rondasPorCondominioChart"></canvas>
                </div>
            </div>
        </div>
    </div>
     <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Atividade de Rondas ao Longo do Tempo</div>
                <div class="card-body">
                    <canvas id="rondaActivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Duração Média (min) por Ronda</div>
                <div class="card-body">
                    <canvas id="duracaoMediaChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Total de Rondas por Turno</div>
                <div class="card-body">
                    <canvas id="rondasPorTurnoChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    {# NOVO: Gráfico de Rondas com Duração Anômala (Baixa Duração) por Condomínio #}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Rondas com Duração Anômala (Baixa Duração) por Condomínio</div>
                <div class="card-body">
                    <canvas id="rondasBaixaDuracaoChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    {% if selected_data_especifica %}
    <hr class="my-4">
    <div class="row mt-4">
        <div class="col-12 text-center mb-3">
            <h4>Análise Detalhada para o Dia {{ data_analise_formatada }}</h4>
            </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Rondas por Turno</div>
                <div class="card-body">
                    <canvas id="rondasPorTurnoDiaChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">Detalhes por Supervisor</div>
                <div class="card-body">
                    {% if dados_tabela_dia %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Supervisor</th>
                                    <th>Turno</th>
                                    <th>Total de Rondas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in dados_tabela_dia %}
                                <tr>
                                    <td>{{ item.username }}</td>
                                    <td>{{ item.turno_ronda }}</td>
                                    <td>{{ item[2] }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Nenhuma ronda registrada para este dia.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# NOVO: Relatório de Anomalias de Rondas #}
    <hr class="my-4">
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-exclamation-octagon-fill me-2 text-danger"></i>Relatório de Anomalias de Rondas</h5>
                </div>
                <div class="card-body">
                    {% if ronda_anomalies_report %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Condomínio</th>
                                    <th>Data Plantão</th>
                                    <th>Supervisor</th>
                                    <th>Início Ronda</th>
                                    <th>Fim Ronda</th>
                                    <th>Motivo da Anomalia</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ronda in ronda_anomalies_report %}
                                <tr>
                                    <td>{{ ronda.id }}</td>
                                    <td>{{ ronda.condominio_obj.nome if ronda.condominio_obj else 'N/A' }}</td>
                                    <td>{{ ronda.data_plantao_ronda.strftime('%d/%m/%Y') if ronda.data_plantao_ronda else 'N/A' }}</td>
                                    <td>{{ ronda.supervisor.username if ronda.supervisor else 'N/A' }}</td>
                                    <td>{{ ronda.primeiro_evento_log_dt | localtime }}</td>
                                    <td>{{ ronda.ultimo_evento_log_dt | localtime }}</td>
                                    <td>
                                        {% if not ronda.data_hora_fim %}
                                            <span class="badge bg-danger me-1">Não Encerrada</span>
                                        {% endif %}
                                        {% if ronda.is_incomplete %}
                                            <span class="badge bg-warning text-dark me-1">Incompleta</span>
                                        {% endif %}
                                        {% if ronda.is_duration_anomalous %}
                                            <span class="badge bg-danger">Duração Anômala</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group" aria-label="Ações da Ronda">
                                            <a href="{{ url_for('ronda.detalhes_ronda', ronda_id=ronda.id) }}" class="btn btn-sm btn-info" title="Ver Detalhes">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{{ url_for('ronda.registrar_ronda', ronda_id=ronda.id) }}" class="btn btn-sm btn-warning" title="Editar Ronda">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Nenhuma anomalia de ronda encontrada com os filtros aplicados.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const barColors = [
            'rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)',
            'rgba(75, 192, 192, 0.6)', 'rgba(255, 206, 86, 0.6)',
            'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'
        ];
        const barBorders = [
            'rgb(54, 162, 235)', 'rgb(255, 99, 132)',
            'rgb(75, 192, 192)', 'rgb(255, 206, 86)',
            'rgb(153, 102, 255)', 'rgb(255, 159, 64)'
        ];

        const renderChart = (ctx, type, labels, data, label, backgroundColor, borderColor) => {
            new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: [{ label: label, data: data, backgroundColor: backgroundColor, borderColor: borderColor, borderWidth: 1, tension: 0.1 }] },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: type === 'bar' && Array.isArray(backgroundColor) ? false : true, } }, scales: { y: { beginAtZero: true } } }
            });
        };

        renderChart(document.getElementById('rondasPorSupervisorChart'), 'bar', {{ supervisor_labels | tojson }}, {{ rondas_por_supervisor_data | tojson }}, '# de Rondas', barColors, barBorders);
        renderChart(document.getElementById('rondasPorCondominioChart'), 'bar', {{ condominio_labels | tojson }}, {{ rondas_por_condominio_data | tojson }}, '# de Rondas', barColors, barBorders);
        renderChart(document.getElementById('rondaActivityChart'), 'bar', {{ ronda_date_labels | tojson }}, {{ ronda_activity_data | tojson }}, 'Total de Rondas por Dia', barColors, barBorders);
        renderChart(document.getElementById('duracaoMediaChart'), 'bar', {{ duracao_condominio_labels | tojson }}, {{ duracao_media_data | tojson }}, 'Duração Média (min)', barColors, barBorders);
        renderChart(document.getElementById('rondasPorTurnoChart'), 'bar', {{ turno_labels | tojson }}, {{ rondas_por_turno_data | tojson }}, '# de Rondas', barColors, barBorders);
        
        // NOVO: Renderiza o gráfico de rondas com baixa duração por condomínio
        renderChart(document.getElementById('rondasBaixaDuracaoChart'), 'bar', {{ condominio_baixa_duracao_labels | tojson }}, {{ rondas_baixa_duracao_data | tojson }}, 'Rondas com Baixa Duração', barColors, barBorders);

        const turnoDiaCtx = document.getElementById('rondasPorTurnoDiaChart');
        const dadosDiaDetalhado = {{ dados_dia_detalhado | tojson }};
        
        if (turnoDiaCtx && dadosDiaDetalhado.labels.length > 0) {
            renderChart(turnoDiaCtx, 'bar', dadosDiaDetalhado.labels, dadosDiaDetalhado.data, '# de Rondas', barColors, barBorders);
        } else if (turnoDiaCtx) {
            turnoDiaCtx.parentNode.innerHTML = '<div class="alert alert-info text-center">Nenhuma ronda encontrada para este dia.</div>';
        }
    });
    </script>
{% endblock %}