services:
  # ============================================================
  # Serviço 1: Backend Flask (Python) - Sistema Principal
  # ============================================================
  - type: web
    name: gestao-seguranca-backend
    env: python
    plan: free
    buildCommand: |
      echo "Building Frontend..."
      cd frontend && npm install && npm run build
      cd ..
      echo "Installing Backend..."
      cd backend
      pip install -r requirements.txt
      cd ..
    startCommand: chmod +x entrypoint.sh && ./entrypoint.sh
    envVars:
      - key: FLASK_ENV
        value: production
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: DATABASE_URL
        sync: false # Defina no painel do Render com a URL do Neon
      - key: SECRET_KEY
        sync: false # Gere uma chave aleatória no painel do Render
      - key: JWT_SECRET_KEY
        sync: false
      - key: WHATSAPP_SERVICE_URL
        sync: false # URL do serviço Node.js abaixo, ex: https://wpp-gestao.onrender.com

  # ============================================================
  # Serviço 2: backend Node.js - Robô WhatsApp (Baileys)
  # IMPORTANTE: Requer um 'Disk' persistente no Render (plano pago)
  # OU usa sessão em Postgres (configurar DATABASE_URL abaixo)
  # ============================================================
  - type: web
    name: gestao-seguranca-whatsapp
    env: node
    plan: free
    rootDir: whatsapp-service
    buildCommand: npm install
    startCommand: node index.js
    envVars:
      - key: PYTHON_API_URL
        sync: false # URL do Flask acima + /api/whatsapp/webhook
        # Exemplo: https://gestao-seguranca-backend.onrender.com/api/whatsapp/webhook
      - key: DATABASE_URL
        sync: false # Mesma URL do Neon - para persistir sessão WhatsApp
      - key: WHATSAPP_PORT
        value: "10000" # Render expõe a porta 10000 por padrão para web services
      - key: NODE_VERSION
        value: "20"
